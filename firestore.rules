service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
       allow read;
       allow write: if isAuthenticated();
    }

    match /users/{userId}/reviews {
       allow read;
       allow write: if isAuthenticated();
    }

    match /users/{userId}/reviews/{reviewId} {
       allow read;
       allow write: if isAuthenticated();
    }

    match /portfolio/{userId}/work/{w} {
       allow read;
       allow write: if isDocumentOwner(userId);
    }

    match /transactions/{transactionId} {
       allow read;
       allow create: if isAuthenticated();
       allow update: if userIsSender();
       allow delete: if isAdmin();
    }

    match /who/{userId}/user/{who} {
       allow read;
       allow write: if isAuthenticated();
    }

    match /viewed-users/{userId}/viewed/{document=**} {
       allow read;
       allow write: if isDocumentOwner(userId);
    }

    match /notifications/{userId} {
       allow read;
       allow write: if isAuthenticated();
    }


    match /skill-tags/{skill} {
       allow read;
    }

    match /chats/{document=**} {
       allow read;
       allow write: if isAuthenticated();
    }

    // TODO: Will require a much more complex rule set here
    match /jobs {
       allow read:if request.auth != null;
    }

    match /jobs/{jobId} {
       allow read;
       allow create: if isAuthenticated();
       allow update: if userIsClientOrProvider();
       allow delete: if isAdmin();
    }

    match /reviews {
       allow read;
       allow write: if isAuthenticated();
    }

    match /reviews/{reviewId} {
       allow read;
       allow write: if isAuthenticated();
    }
  }

  // --------------------------------------------------------------------------------
  function isAuthenticated() {
    return request.auth != null
  }

  function isDocumentOwner(userId) {
    return request.auth.uid == userId
  }

  function userIsSender() {
    return request.resource.data.senderId == request.auth.uid
    || isAdmin()
  }

  function userIsClientOrProvider() {
    return request.resource.data.clientId == request.auth.uid
    || request.resource.data.providerId == request.auth.uid
    || isAdmin()
  }

  function getUserData() {
    return get(/databases/$(database)/documents/users/$(request.auth.uid)).data
  }

  function isAdmin() {
    return getUserData().isAdmin
  }
 // --------------------------------------------------------------------------------
}
